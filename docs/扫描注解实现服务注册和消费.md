# æ‰«ææ³¨è§£å®ç°æœåŠ¡æ³¨å†Œå’Œæ¶ˆè´¹



ğŸ“Œä½¿ç”¨çš„ `Spring` æ¡†æ¶ç•™çš„æ¥å£å’Œæ³¨è§£é…åˆå®ç°è‡ªå®šä¹‰æ‰«ææ³¨è§£



## @RpcServiceæ ‡æ³¨æœåŠ¡ç«¯æä¾›çš„å®ç°ç±»

- æœåŠ¡å®ç°ç±»ä½¿ç”¨ `@RpcService` æ ‡æ³¨ï¼Œå¹¶é…ç½®å¥½ç»„åã€Œgroupã€å’Œç‰ˆæœ¬ã€Œversionã€

![image-20220201192149061](./img/RPCæœåŠ¡å®ç°ç±».png)

- `@RpcService` æºç 
  - `group` ç”¨äºåŒºåˆ†åŒä¸ªæ¥å£çš„å¤šç§å®ç°
  - `version` ç”¨äºæ¥å£ä¸å…¼å®¹å‡çº§ï¼Œç‰ˆæœ¬å·è¿‡æ¸¡ã€‚ç‰ˆæœ¬å·ä¸åŒçš„æœåŠ¡ç›¸äº’ä¸è°ƒç”¨

![RpcServiceæºç ](./img/RpcServiceæºç .png)



## @RpcScanæ‰«æ@RpcServiceæœåŠ¡æ³¨å†Œ

- `@RpcScan` æºç 
  - `@Import` ä¸º `Spring` æ¡†æ¶æä¾›çš„å¯¼å…¥æ³¨è§£ï¼Œå¯¼å…¥çš„ç±»è‡ªå®šä¹‰æ‰«æåçš„é€»è¾‘

![RpcScanæºç ](./img/RpcScanæºç .png)



## RpcServiceScannerRegistrar ç¼–å†™æ‰«æåçš„æ³¨å†Œé€»è¾‘

- `ResourceLoaderAware` æ¥å£æä¾›å˜é‡ `resourceLoader`
- å®ç° `ImportBeanDefinitionRegistrar` æ¥å£ï¼Œé‡å†™ `registerBeanDefinitions` æ³¨å†Œé€»è¾‘
- `MyClassPathBeanScanner` æ˜¯æ‰«æå®ç°çš„æ ¸å¿ƒï¼Œå½¢å‚ä¸º `BeanDefinitionRegistry` å’Œéœ€è¦æ‰«æçš„ `Bean Class`
- `@RpcScan` æ ¹æ®ä¸‹é¢å®ç°ï¼Œä¼šæ‰«æ `@Component` å’Œ `@RpcService` çš„ `bean` å¯¹è±¡

```java
public class RpcServiceScannerRegistrar implements ImportBeanDefinitionRegistrar, ResourceLoaderAware {

    public static final String BEAN_BASE_PACKAGE = "me.hypocrite30";
    private static final String BASE_PACKAGE_ATTRIBUTE_NAME = "basePackage";
    private ResourceLoader resourceLoader;

    @Override
    public void setResourceLoader(ResourceLoader resourceLoader) {
        this.resourceLoader = resourceLoader;
    }

    /**
     * Firstly scan class which has @RpcScan to get all Rpc class
     * Then scan annotated class with @me.hypocrite30.rpc.core.annotation.RpcService | @org.springframework.stereotype.Component
     *
     * @param annotationMetadata     to get annotation meta data
     * @param beanDefinitionRegistry to register bean
     */
    @Override
    public void registerBeanDefinitions(AnnotationMetadata annotationMetadata, BeanDefinitionRegistry beanDefinitionRegistry) {
        // get all annotations' attributes and value, store as LinkedHashMap<String, Object>
        AnnotationAttributes rpcScanAnnotationAttributes = AnnotationAttributes.fromMap(annotationMetadata.getAnnotationAttributes(RpcScan.class.getName()));
        String[] rpcScanBasePackages = new String[0];
        if (rpcScanAnnotationAttributes != null) {
            // get the value of the basePackage attribute
            rpcScanBasePackages = rpcScanAnnotationAttributes.getStringArray(BASE_PACKAGE_ATTRIBUTE_NAME);
        }
        if (rpcScanBasePackages.length == 0) {
            // if have not set basePackage scan path, just scan the value under the corresponding package
            rpcScanBasePackages = new String[]{((StandardAnnotationMetadata) annotationMetadata).getIntrospectedClass().getPackage().getName()};
        }
        // Scan the RpcService annotation
        MyClassPathBeanScanner rpcServiceScanner = new MyClassPathBeanScanner(beanDefinitionRegistry, RpcService.class);
        // Scan the Component annotation
        MyClassPathBeanScanner springBeanScanner = new MyClassPathBeanScanner(beanDefinitionRegistry, Component.class);
        // put ResourceLoader into all scanner
        if (resourceLoader != null) {
            rpcServiceScanner.setResourceLoader(resourceLoader);
            springBeanScanner.setResourceLoader(resourceLoader);
        }
        // scan by ClassPathBeanDefinitionScanner
        int springBeanAmount = springBeanScanner.scan(BEAN_BASE_PACKAGE);
        log.info("spring bean amount: [{}]", springBeanAmount);
        int rpcServiceCount = rpcServiceScanner.scan(rpcScanBasePackages);
        log.info("rpc service amount: [{}]", rpcServiceCount);
    }
}
```

- `MyClassPathBeanScanner` æºç 

```java
public class MyClassPathBeanScanner extends ClassPathBeanDefinitionScanner {

    public MyClassPathBeanScanner(BeanDefinitionRegistry registry, Class<? extends Annotation> annoType) {
        super(registry);
        // add filter by annotation type
        super.addIncludeFilter(new AnnotationTypeFilter(annoType));
    }

    /**
     * scan from basePackages
     *
     * @param basePackages base packages
     * @return number of scanned
     */
    @Override
    public int scan(String... basePackages) {
        return super.scan(basePackages);
    }

}
```



## SpringBeanPostProcessor ç¼–å†™æ‰«æåæ³¨å†Œé€»è¾‘

- æ˜¯ä¸€ä¸ª `Component` ï¼Œèƒ½è¢«æ‰«æåˆ°ä½œä¸º Bean å®ä¾‹æ³¨å†Œåˆ° IOC å®¹å™¨é‡Œ
- å®ç° `BeanPostProcessor` æ–¹æ³•ï¼Œé‡å†™ `postProcessBeforeInitialization` å’Œ `postProcessAfterInitialization ` æ–¹æ³•ï¼Œç¼–å†™å‘å¸ƒå‰åçš„é€»è¾‘

```java
@Slf4j
@Component
public class SpringBeanPostProcessor implements BeanPostProcessor 
```



- ç¼–å†™ post ä¹‹å‰çš„é€»è¾‘
- é¦–å…ˆåˆ¤æ–­å½“å‰ Bean æ˜¯å¦ä¸º `@RpcService` æœåŠ¡
- è·å– `RpcService` çš„ `group` å’Œ `version`ï¼Œå¹¶å°†å½“å‰ RpcService æœåŠ¡å¯¹è±¡å°è£…åˆ° `Config` ä¸­ï¼Œç„¶åäº¤ç»™ `ServiceProvider` å‘å¸ƒè¯¥æœåŠ¡åˆ°æ³¨å†Œä¸­å¿ƒ

```java
@Override
public Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException {
    if (bean.getClass().isAnnotationPresent(RpcService.class)) {
        log.info("[{}] is annotated with [{}]", bean.getClass().getName(), RpcService.class.getCanonicalName());
        // get @RpcService
        RpcService rpcService = bean.getClass().getAnnotation(RpcService.class);
        // build service config with service bean
        RpcServiceConfig rpcServiceConfig = RpcServiceConfig.builder()
                .group(rpcService.group())
                .version(rpcService.version())
                .service(bean).build();
        serviceProvider.publishService(rpcServiceConfig);
    }
    return bean;
}
```



- ç¼–å†™ post ä¹‹åçš„é€»è¾‘
- ç”±äºå®¢æˆ·ç«¯æ²¡æœ‰ RpcService çš„å®ç°ï¼Œéœ€è¦é€šè¿‡ä»£ç†ç±»å‘å‡º RPC è¯·æ±‚æ¥æ¨¡æ‹Ÿå¤„ç†è¿‡ç¨‹ï¼›è¯¥è¿‡ç¨‹æ‰«æ `@RpcReference` ï¼Œç„¶åç”Ÿæˆ `ClientProxy` ä»£ç†å¯¹è±¡ï¼Œæœ€åå°†è¯¥ä»£ç†å¯¹è±¡æ›¿æ¢ bean çš„å®ç°
- åœ¨ post bean ä¹‹åï¼Œè·å–æˆå‘˜å˜é‡ï¼Œæ‰¾åˆ°å¸¦æœ‰ `@RpcReference` çš„å˜é‡ï¼Œè·å–éœ€è¦ä»£ç†çš„ group å’Œ version
- å°è£…å¥½è¯·æ±‚åï¼Œç”Ÿæˆä»£ç†å¯¹è±¡ï¼Œæœ€åæŠŠ bean çš„å®ç°è®¾ç½®ä¸º RPC ä»£ç†å¯¹è±¡

```java
@Override
public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException {
    Class<?> targetClz = bean.getClass();
    Field[] declaredFields = targetClz.getDeclaredFields();
    for (Field declaredField : declaredFields) {
        RpcReference rpcReference = declaredField.getAnnotation(RpcReference.class);
        if (rpcReference != null) {
            RpcServiceConfig rpcServiceConfig = RpcServiceConfig.builder()
                    .group(rpcReference.group())
                    .version(rpcReference.version()).build();
            RpcClientProxy rpcClientProxy = new RpcClientProxy(nettyRpcClient, rpcServiceConfig);
            Object clientProxy = rpcClientProxy.getProxy(declaredField.getType());
            declaredField.setAccessible(true);
            try {
                declaredField.set(bean, clientProxy);
            } catch (IllegalAccessException e) {
                log.error("IllegalAccessException: ", e);
            }
        }
    }
    return bean;
}
```

- `@RpcReference` æºç 
  - ç”¨äºæ ‡è¯†éœ€è¦ä»£ç†çš„ RPC æœåŠ¡ï¼Œç±»ä¼¼ `@Autowired`ï¼Œä½†ä¸æ˜¯ä» IOC å®¹å™¨ä¸­æ³¨å…¥ beanã€‚é€»è¾‘å¦‚ä¸Šï¼Œç”Ÿæˆä»£ç†å¯¹è±¡æ›¿ä»£å®ç°ï¼Œå®¢æˆ·ç«¯è°ƒç”¨ï¼Œåˆ™ä¼šä»£ç†è¯·æ±‚ RPC æœåŠ¡

![RpcReferenceæºç ](./img/RpcReferenceæºç .png)

- æœ€ç»ˆæœåŠ¡è¢«æ›¿æ¢ä¸ºå®¢æˆ·ç«¯ä»£ç†å¯¹è±¡

![æœåŠ¡è¢«æ›¿æ¢ä¸ºå®¢æˆ·ç«¯ä»£ç†å¯¹è±¡](./img/æœåŠ¡è¢«æ›¿æ¢ä¸ºå®¢æˆ·ç«¯ä»£ç†å¯¹è±¡.png)

